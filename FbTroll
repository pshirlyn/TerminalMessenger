var fs = require('fs');
var login = require("facebook-chat-api");
var config = require('./config');
var util = require('util');


var outputFile = fs.createWriteStream('fb.output', { flags: 'w' });

output = function (d) { //
    outputFile.write(util.format(d) + '\n');
};

login({email: config.useraccount.email, password: config.useraccount.password}, function callback (err, api) {
    if(err) return console.error(err);
    api.listen(function callback(err, message) {
    	var sender, threadName;
    	api.getUserInfo(message.senderID, function(err, ret) {
    		if(err) return console.error(err);

    		//console.log(ret.firstName);
    		//console.log(message.senderID, ret.name);
            //output(message.senderID, ret.name);
    	});
    	api.getThreadInfo(message.threadID, function callback(err, info) {
    		if(err) return console.error(err);
    		if(info.name == null) {
    			threadName = message.threadID;
    		} else {
    			threadName = info.name;
                console.log(threadName, message.senderID, message.body);
                output(message.threadID, message.senderID, message.body);
    		}
    	});
    }); 	
});